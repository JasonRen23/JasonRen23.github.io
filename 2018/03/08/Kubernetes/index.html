<!DOCTYPE HTML><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><title>Kubernetes部署指南 | JasonRen&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="author" content="JasonRen"><meta name="description" content="最近忙于面试，为了缓解紧张的备战心情，更新一下之前总结的一些关于k8s的部署指南，包括单机版和集群版。"><meta name="keywords" content="kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="Kubernetes部署指南"><meta property="og:url" content="https://jasonren.top/2018/03/08/Kubernetes/index.html"><meta property="og:site_name" content="JasonRen&#39;s Blog"><meta property="og:description" content="最近忙于面试，为了缓解紧张的备战心情，更新一下之前总结的一些关于k8s的部署指南，包括单机版和集群版。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://ws1.sinaimg.cn/large/73d640f7gy1ftl9vxtsxvj20wp0fkdmx.jpg"><meta property="og:updated_time" content="2018-11-22T07:51:49.930Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kubernetes部署指南"><meta name="twitter:description" content="最近忙于面试，为了缓解紧张的备战心情，更新一下之前总结的一些关于k8s的部署指南，包括单机版和集群版。"><meta name="twitter:image" content="https://ws1.sinaimg.cn/large/73d640f7gy1ftl9vxtsxvj20wp0fkdmx.jpg"><link rel="alternative" href="/atom.xml" title="JasonRen&#39;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.ico"><link rel="apple-touch-icon" href="/img/cat.png"><link rel="apple-touch-icon-precomposed" href="/img/cat.png"><link rel="stylesheet" href="/css/style.css"></head></html><body><header><div><div id="imglogo"><a href="/"><img src="/img/cat.png" alt="JasonRen&#39;s Blog" title="JasonRen&#39;s Blog"></a></div><div id="textlogo"><h1 class="site-name"><a href="/" title="JasonRen&#39;s Blog">JasonRen&#39;s Blog</a></h1><h2 class="blog-motto">Hello World!</h2></div><div class="navbar"><a class="navbutton navmobile" href="#" title="Menu"></a></div><nav class="animated"><ul><ul><li><a href="/">主页|Home</a></li><li><a href="/archives">归档|Archives</a></li><li><a href="/about">关于|About</a></li><li><form class="search" action="//google.com/search" method="get" accept-charset="utf-8"><label>Search</label> <input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search"> <input type="hidden" name="q" value="site:jasonren.top"></form></li></ul></ul></nav></div></header><div id="container"><div id="main" class="post" itemscope itemprop="blogPost"><article itemprop="articleBody"><header class="article-info clearfix"><h1 itemprop="name"><a href="/2018/03/08/Kubernetes/" title="Kubernetes部署指南" itemprop="url">Kubernetes部署指南</a></h1><p class="article-author">By <a href="/about" title="JasonRen" target="_blank" itemprop="author">JasonRen</a></p><p class="article-time"><time datetime="2018-03-07T16:00:00.000Z" itemprop="datePublished">Published 2018-03-08</time></p></header><div class="article-content"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#单机版-kubernetes"><span class="toc-number">1.</span> <span class="toc-text">单机版 kubernetes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单机版k8s的小例子"><span class="toc-number">2.</span> <span class="toc-text">单机版k8s的小例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-MySQL-容器服务"><span class="toc-number">2.1.</span> <span class="toc-text">启动 MySQL 容器服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Web-容器服务"><span class="toc-number">2.2.</span> <span class="toc-text">启动 Web 容器服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多-Node（Minion）的-kubernetes-cluster"><span class="toc-number">3.</span> <span class="toc-text">多 Node（Minion）的 kubernetes cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rc-创建-pod-时访问-private-registry-获取-docker-image"><span class="toc-number">4.</span> <span class="toc-text">rc 创建 pod 时访问 private registry 获取 docker image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#外部系统访问Service的问题"><span class="toc-number">5.</span> <span class="toc-text">外部系统访问Service的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储卷本地挂载实现"><span class="toc-number">6.</span> <span class="toc-text">存储卷本地挂载实现</span></a></li></ol></div><p>最近忙于面试，为了缓解紧张的备战心情，更新一下之前总结的一些关于k8s的部署指南，包括<strong>单机版</strong>和<strong>集群版</strong>。<br><img src="https://ws1.sinaimg.cn/large/73d640f7gy1ftl9vxtsxvj20wp0fkdmx.jpg" alt=""><br><a id="more"></a></p><h2 id="单机版-kubernetes"><a href="#单机版-kubernetes" class="headerlink" title="单机版 kubernetes"></a>单机版 kubernetes</h2><p>即 Master 和 Node （Minion）为同一台机器<br></p><p>关闭防火墙<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure><p></p><p>安装启用 iptabels<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iptables-services</span><br><span class="line">systemctl <span class="built_in">enable</span> iptables.service</span><br><span class="line">systemctl start iptables.service</span><br></pre></td></tr></table></figure><p></p><p>配置 kubernetes yum 源<br></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgcheck=<span class="number">0</span></span><br><span class="line">repo_gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http<span class="variable">s:</span>//packages.cloud.google.<span class="keyword">com</span>/yum/doc/yum-key.gpg</span><br><span class="line">http<span class="variable">s:</span>//packages.cloud.google.<span class="keyword">com</span>/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure><p></p><p>安装etcd 和k8s<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y etcd kubernetes</span><br></pre></td></tr></table></figure><p></p><p>安装过程中会安装 docker，为了防止与已有 docker 版本冲突，安装之前最好卸载掉已有的 docker。<br>修改配置文件</p><ul><li>Docker 配置文件 /etc/sysconfig/docker<br><code>vim /etc/sysconfig/docker</code><br><br>其中的OPTIONS的内容设置为如下<br><code>OPTIONS=&#39;--selinux-enabled=false --insecure-registry gcr.io&#39;</code></li><li><p>apiserver 配置文件 /etc/kubernetes/apiserver<br><code>vim /etc/kubernetes/apiserver</code><br><br>删除 KUBE_ADMISSION_CONTROL 中的 ServiceAccount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--admission_control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota"</span></span><br></pre></td></tr></table></figure></li><li><p>改为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBE_ADMISSION_CONTROL=<span class="string">"--admission_control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota"</span></span><br></pre></td></tr></table></figure></li></ul><p>按照顺序启动服务<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl start etcd</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl start kube-apiserver.service</span><br><span class="line">systemctl start kube-controller-manager.service</span><br><span class="line">systemctl start kube-scheduler.service</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl start kube-proxy.service</span><br></pre></td></tr></table></figure><p></p><h2 id="单机版k8s的小例子"><a href="#单机版k8s的小例子" class="headerlink" title="单机版k8s的小例子"></a>单机版k8s的小例子</h2><p>以上步骤完成了单机版 kubernetes 的安装启动，以下为一个简单的小例子来测试运行。</p><h3 id="启动-MySQL-容器服务"><a href="#启动-MySQL-容器服务" class="headerlink" title="启动 MySQL 容器服务"></a>启动 MySQL 容器服务</h3><ul><li>先拉取所需的 docker image 方便 rc 进行 pod 创建时使用<br><code>docker pull mysql</code></li><li><p>创建文件 mysql-rc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"123456"</span></span><br></pre></td></tr></table></figure></li><li><p>创建 rc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f mysql-rc.yaml</span><br><span class="line">replicationcontroller <span class="string">'mysql'</span> created</span><br></pre></td></tr></table></figure></li><li><p>查看 rc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rc</span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">mysql 1 1 0 14s</span><br></pre></td></tr></table></figure></li><li><p>查看 pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">mysql-b0gk0 0/1 ContainerCreating 0 3s</span><br></pre></td></tr></table></figure></li><li><p>此时pod 的状态处于 ContainerCreating，需要等待一下，直到状态变为Running</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">mysql-b0gk0 1/1 Running 0 6m</span><br></pre></td></tr></table></figure></li><li><p>创建文件 mysql-svc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure></li><li><p>创建 service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f mysql-svc.yaml</span><br><span class="line">service <span class="string">"mysql"</span> created</span><br></pre></td></tr></table></figure></li><li><p>查看service状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc</span><br><span class="line">NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">kubernetes 10.254.0.1 &lt;none&gt; 443/TCP 18m</span><br><span class="line">mysql 10.254.185.20 &lt;none&gt; 3306/TCP 14s</span><br></pre></td></tr></table></figure></li><li><p><strong>注意到MySQL服务被分配了一个值为 10.254.185.20 的 CLUSTER-IP，这是一个虚地址，随后，Kubernetes 集群中的其他新创建的 Pod 就可以通过Service 的 CLUSTER-IP + 端口 6379 来连接和访问它了。</strong></p></li></ul><h3 id="启动-Web-容器服务"><a href="#启动-Web-容器服务" class="headerlink" title="启动 Web 容器服务"></a>启动 Web 容器服务</h3><ul><li>先拉取所需的 docker image 方便 rc 进行 pod 创建时使用<br><code>docker pull kubeguide/tomcat-app:v1</code></li><li><p>创建文件 myweb-rc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">kubeguide/tomcat-app:v1</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">          - containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure></li><li><p>创建rc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f myweb-rc.yaml</span><br><span class="line">replicationcontroller <span class="string">"myweb"</span> created</span><br></pre></td></tr></table></figure></li><li><p>查看rc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get rc</span><br><span class="line">NAME DESIRED CURRENT READY AGE</span><br><span class="line">mysql 1 1 1 43m</span><br><span class="line">myweb 5 5 0 21s</span><br></pre></td></tr></table></figure></li><li><p>查看 pod，根据 rc 中的设置，有 5 个 replicas</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME READY STATUS RESTARTS AGE</span><br><span class="line">mysql-wk349 1/1 Running 0 44m</span><br><span class="line">myweb-dlfwg 1/1 Running 0 58s</span><br><span class="line">myweb-m0j9c 1/1 Running 0 58s</span><br><span class="line">myweb-tss55 1/1 Running 0 58s</span><br><span class="line">myweb-v9p21 1/1 Running 0 58s</span><br><span class="line">myweb-w5bs4 1/1 Running 0 58s</span><br></pre></td></tr></table></figure></li><li><p>创建文件myweb-svc.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure></li><li><p>创建service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f myweb-svc.yaml</span><br><span class="line">service <span class="string">"myweb"</span> created</span><br></pre></td></tr></table></figure></li><li><p>查看 service</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services</span><br><span class="line">NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">kubernetes 10.254.0.1 &lt;none&gt; 443/TCP 5h</span><br><span class="line">mysql 10.254.201.141 &lt;none&gt; 3306/TCP 45m</span><br><span class="line">myweb 10.254.90.94 &lt;nodes&gt; 8080:30001/TCP 23s</span><br></pre></td></tr></table></figure></li></ul><p><strong>至此，完成了一个简单的 kubernetes 单机版例子，可以在浏览器输入 <a href="http://ip:30001/demo/" target="_blank" rel="noopener">http://ip:30001/demo/</a> 来测试发布的web应用</strong></p><h2 id="多-Node（Minion）的-kubernetes-cluster"><a href="#多-Node（Minion）的-kubernetes-cluster" class="headerlink" title="多 Node（Minion）的 kubernetes cluster"></a>多 Node（Minion）的 kubernetes cluster</h2><p>为上述单机版的添加一个新的 node。<br>以下没有特别说明的时候，都是在 node 上进行的操作。</p><p>关闭防火墙<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure><p></p><p>安装启用 iptabels<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iptables-services</span><br><span class="line">systemctl start iptables.service</span><br><span class="line">systemctl <span class="built_in">enable</span> iptables.service</span><br></pre></td></tr></table></figure><p></p><p>配置 yum 源<br></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgcheck=<span class="number">0</span></span><br><span class="line">repo_gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=http<span class="variable">s:</span>//packages.cloud.google.<span class="keyword">com</span>/yum/doc/yum-key.gpg</span><br><span class="line">http<span class="variable">s:</span>//packages.cloud.google.<span class="keyword">com</span>/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure><p></p><p>安装 kubernetes<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubernetes</span><br></pre></td></tr></table></figure><p></p><ul><li><strong>安装过程中会安装 docker，为了防止与已有 docker 版本冲突，安装之前最好卸载掉已有的 docker</strong></li><li><strong>与 Master 不同，Node 不用安装 etcd，在后面配置中指向 Master 的 etcd server 即可</strong><br></li></ul><p>修改配置文件</p><ul><li><p>Master 上<br>修改配置 Master 和 etcd server 信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/config</span><br><span class="line">KUBE_MASTER=<span class="string">"--master=http://10.75.12.117:8080"</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=http://10.75.12.117:2379"</span></span><br></pre></td></tr></table></figure></li><li><p>默认值是 127.0.0.1 ，换成 Master 的具体 IP，与 /etc/etcd/etcd.conf 中的设置一致<br><br><code>ETCD_LISTEN_CLIENT_URLS=&quot;http://10.75.12.117:2379&quot;</code><br></p></li><li><p>如果有修改 etcd.conf 要重启 etcd， <code>systemctl restart etcd</code></p></li><li><p>修改配置 api server 信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/apiserver</span><br><span class="line">KUBE_API_ADDRESS=<span class="string">"--insecure-bind-address=0.0.0.0"</span></span><br><span class="line">KUBE_API_PORT=<span class="string">"--port=8080"</span></span><br><span class="line"><span class="comment"># KUBE_ETCD_SERVERS="--etcd-servers=http://127.0.0.1:2379"</span></span><br></pre></td></tr></table></figure></li><li><p>注释掉 KUBE_ETCD_SERVERS，config 中已经设置过了</p></li><li><p>重启 Master 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart etcd</span><br><span class="line">systemctl restart kube-apiserver.service</span><br><span class="line">systemctl restart kube-controller-manager.service</span><br><span class="line">systemctl restart kube-scheduler.service</span><br></pre></td></tr></table></figure></li><li><p>Node 上<br>单机版的 Master 作为 Node 时，配置文件修改方式和单独作为 Node 节点的配置文件修改一样。</p></li><li><p>设置指向 Master 和 etcd server</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/kubernetes/config</span><br><span class="line">KUBE_MASTER=<span class="string">"--master=http://10.75.12.117:8080"</span></span><br><span class="line">KUBE_ETCD_SERVERS=<span class="string">"--etcd-servers=http://10.75.12.117:2379"</span></span><br><span class="line"><span class="number">10.75</span>.<span class="number">12.117</span> 为 Master IP</span><br></pre></td></tr></table></figure></li><li><p>修改 kubelet</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/kubernetes/kubelet</span><br><span class="line">KUBELET_ADDRESS=<span class="string">"--address=0.0.0.0"</span></span><br><span class="line">KUBELET_PORT=<span class="string">"--port=10250"</span></span><br><span class="line">KUBELET_HOSTNAME=<span class="string">"--hostname-override=10.75.12.120"</span> </span><br><span class="line">KUBELET_API_SERVER=<span class="string">"--api-servers=http://10.75.12.117:8080"</span></span><br></pre></td></tr></table></figure></li><li><p>KUBELET_HOSTNAME 为具体的当前 node hostname/IP， 确保是能够解析的 hostname，否则找不到是不能向 Master 注册 Node 的。<br></p><p>启动 Node 的服务</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl start kube-proxy.service</span><br></pre></td></tr></table></figure><p>在<code>/var/log/messages</code> 中提取查看 kube 的信息，可以看到 Node 向 Master 注册自己。<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Aug  2 21:55:28 localhost kubelet: I0802 21:55:28.449019   24104 kubelet_node_status.go:77] Successfully registered node 10.75.12.120</span><br></pre></td></tr></table></figure><p></p><p>在 Master 上查看 Node，可以看到新注册进去的 Node。<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME STATUS AGE</span><br><span class="line">127.0.0.1 NotReady 2m</span><br><span class="line">10.75.12.120 Ready 5m</span><br><span class="line">10.75.12.117 Ready 6m</span><br></pre></td></tr></table></figure><p></p><p><code>10.75.12.120</code> 是新添加的 node，<code>10.75.12.117</code> 是 Master 上进行修改添加的 node，所以原来的 <code>127.0.0.1</code>被替换注册后，处于<code>NotReady</code>状态。</p><p><strong>如果出现 node 注册失败，请检查 Master 和 node 网络是否联通，iptables 的设置中是否有相应的 rule 进行阻拦。</strong></p><h2 id="rc-创建-pod-时访问-private-registry-获取-docker-image"><a href="#rc-创建-pod-时访问-private-registry-获取-docker-image" class="headerlink" title="rc 创建 pod 时访问 private registry 获取 docker image"></a>rc 创建 pod 时访问 private registry 获取 docker image</h2><p>非 public registry 获取 docker image 时，需要使用 <code>Secret</code></p><ul><li><p>创建 Secret<br>使用 kubectl create secret 命令创建 secret，指定 private registry 名称，对应的访问地址，以及访问使用的用户名和密码，最后是邮箱<br><code>kubectl create secret docker-registry regsecret --docker-server=&lt;your-registry-server&gt; --docker-username=&lt;your-name&gt; --docker-password=&lt;your-pword&gt; --docker-email=&lt;your-email&gt;</code><br>比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry mysecret --docker-server=yourRegistry.com --docker-username=sdn --docker-password=sdn123 --docker-email=zhicheng_ren@163.com</span><br></pre></td></tr></table></figure></li><li><p>查看创建的 secret</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get secret</span><br><span class="line">NAME        TYPE                      DATA      AGE</span><br><span class="line">sdnsecret   kubernetes.io/dockercfg   1         3m</span><br></pre></td></tr></table></figure></li><li><p>rc 中使用 Secret<br>获取 private registry 中的 docker image 时，需要使用对应的 secret 提供访问权限<br>在 rc 中 spec.template.spec 下添加 imagePullSecrets 指定使用的 secret<br>比如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">lab-cloud-controller</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">lab-cloud-controller</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">lab-cloud-controller</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">lab-cloud-controller</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">lab-cloud/lab-cloud-controller:latest</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          hostPort:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">5005</span></span><br><span class="line"><span class="attr">          hostPort:</span> <span class="number">5005</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NSO_SERVICE_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"nso-service"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NSO_SERVICE_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"8080"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CASSANDRA_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"cassandra"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CASSANDRA_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"9042"</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">sdnsecret</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="外部系统访问Service的问题"><a href="#外部系统访问Service的问题" class="headerlink" title="外部系统访问Service的问题"></a>外部系统访问Service的问题</h2><p>Kubernetes中有三种IP：</p><ul><li>Node IP：Node节点的IP地址</li><li>Pod IP：Pod的IP地址</li><li>Cluster IP：Service的IP地址<br>Service的Cluster IP属于Kubernetes集群内部的地址，无法在集群外部直接使用这个地址。<br>采用<code>NodePort</code>是解决此问题最直接有效的办法，具体做法如下，以部署mongodb service(mongo-svc.yaml)为例：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure></li></ul><p>NodePort的实现方式是在Kubernetes集群里的每个Node上为需要外部访问的Service开启一个对应的TCP监听端口，外部系统只要用任意一个Node的IP地址+具体的NodePort端口号即可访问此服务。下面为在任意节点netstat运行后的结果：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp6       0      0 [::]:27017              [::]:*                  LISTEN      4015/kube-proxy</span><br></pre></td></tr></table></figure><p></p><p>注意：请查看docker已正确启动后再启动服务，否则服务将无法访问，可使用如下命令查看：<br><code>kubectl logs &lt;PodName&gt;</code></p><p>若一直卡在“waiting for connection”这个进程，可能是端口冲突导致container无法创建，这样即使服务创建好外部也无法访问。<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] MongoDB starting : pid=1 port=27017 dbpath=/data/db 64-bit host=mongo-controller-nbgsr</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] db version v3.4.10</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] git version: 078f28920cb24de0dd479b5ea6c66c644f6326e9</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] OpenSSL version: OpenSSL 1.0.1t  3 May 2016</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] allocator: tcmalloc</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] modules: none</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] build environment:</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten]     distmod: debian81</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten]     distarch: x86_64</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten]     target_arch: x86_64</span><br><span class="line">2017-11-01T20:11:38.314+0000 I CONTROL  [initandlisten] options: &#123;&#125;</span><br><span class="line">2017-11-01T20:11:38.318+0000 I -        [initandlisten] Detected data files <span class="keyword">in</span> /data/db created by the <span class="string">'wiredTiger'</span> storage engine, so setting the active storage engine to <span class="string">'wiredTiger'</span>.</span><br><span class="line">2017-11-01T20:11:38.318+0000 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=31621M,session_max=20000,eviction=(threads_min=4,threads_max=4),config_base=<span class="literal">false</span>,statistics=(fast),<span class="built_in">log</span>=(enabled=<span class="literal">true</span>,archive=<span class="literal">true</span>,path=journal,compressor=snappy),file_manager=(close_idle_time=100000),checkpoint=(<span class="built_in">wait</span>=60,log_size=2GB),statistics_log=(<span class="built_in">wait</span>=0),</span><br><span class="line">2017-11-01T20:11:38.935+0000 I CONTROL  [initandlisten] </span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled <span class="keyword">for</span> the database.</span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.</span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] </span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] </span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="string">'always'</span>.</span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] **        We suggest setting it to <span class="string">'never'</span></span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] </span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="string">'always'</span>.</span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] **        We suggest setting it to <span class="string">'never'</span></span><br><span class="line">2017-11-01T20:11:38.936+0000 I CONTROL  [initandlisten] </span><br><span class="line">2017-11-01T20:11:38.938+0000 I FTDC     [initandlisten] Initializing full-time diagnostic data capture with directory <span class="string">'/data/db/diagnostic.data'</span></span><br><span class="line">2017-11-01T20:11:38.938+0000 I NETWORK  [thread1] waiting <span class="keyword">for</span> connections on port 27017</span><br></pre></td></tr></table></figure><p></p><h2 id="存储卷本地挂载实现"><a href="#存储卷本地挂载实现" class="headerlink" title="存储卷本地挂载实现"></a>存储卷本地挂载实现</h2><p>在一般情况下，若不进行存储卷设置，Pod或者rc一旦被删除，之前数据库存储的数据便会丢失。<code>Volume</code>的使用比较简单，在大多数情况下，先在Pod上声明一个Volume，然后在容器内引用该Volume并挂载mount到容器内的某个目录上。例子mongo-rc.yaml如下(注意缩进问题)：<br></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">   containers:</span></span><br><span class="line"><span class="attr">   - image:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">     name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">     ports:</span></span><br><span class="line"><span class="attr">     - name:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">       containerPort:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">     volumeMounts:</span></span><br><span class="line"><span class="attr">         - mountPath:</span> <span class="string">/data/db</span></span><br><span class="line"><span class="attr">           name:</span> <span class="string">mongo-persistent-storage</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">         - name:</span> <span class="string">mongo-persistent-storage</span></span><br><span class="line"><span class="attr">           hostPath:</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">/data/db/mongo_data</span></span><br></pre></td></tr></table></figure><p></p><p>这样便将宿主机上<code>/data/db/mongo_data</code>的本地存储卷挂载到了容器内的<code>/data/db</code>目录上，这样MongoDB一旦进行写入数据操作，本地即会进行相应的缓存操作。就算rc、pod、service挂了，当服务重启时，它会加载本地缓存数据，及时的恢复数据。</p></div><footer class="article-footer clearfix"><div class="article-catetags"><div class="article-categories"><span></span> <a class="article-category-link" href="/categories/容器云/">容器云</a></div><div class="article-tags"><span></span> <a href="/tags/kubernetes/">kubernetes</a></div></div><div class="article-share" id="share"><div data-url="https://jasonren.top/2018/03/08/Kubernetes/" data-title="Kubernetes部署指南 | JasonRen&#39;s Blog" data-tsina="null" class="share clearfix"></div></div></footer></article><nav class="article-nav clearfix"><div class="prev"><a href="/2018/04/08/java内存区域/" title="Java内存区域"><strong>上一篇：</strong><br><span>Java内存区域</span></a></div><div class="next"><a href="/2018/03/02/ConcurrentHashMap/" title="ConcurrentHashMap总结"><strong>下一篇：</strong><br><span>ConcurrentHashMap总结</span></a></div></nav><section id="comments" class="comment"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div><div id="toc" class="toc-aside"><strong class="toc-title">Contents</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#单机版-kubernetes"><span class="toc-number">1.</span> <span class="toc-text">单机版 kubernetes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单机版k8s的小例子"><span class="toc-number">2.</span> <span class="toc-text">单机版k8s的小例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-MySQL-容器服务"><span class="toc-number">2.1.</span> <span class="toc-text">启动 MySQL 容器服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-Web-容器服务"><span class="toc-number">2.2.</span> <span class="toc-text">启动 Web 容器服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多-Node（Minion）的-kubernetes-cluster"><span class="toc-number">3.</span> <span class="toc-text">多 Node（Minion）的 kubernetes cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rc-创建-pod-时访问-private-registry-获取-docker-image"><span class="toc-number">4.</span> <span class="toc-text">rc 创建 pod 时访问 private registry 获取 docker image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#外部系统访问Service的问题"><span class="toc-number">5.</span> <span class="toc-text">外部系统访问Service的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储卷本地挂载实现"><span class="toc-number">6.</span> <span class="toc-text">存储卷本地挂载实现</span></a></li></ol></div><div id="asidepart"><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div><aside class="clearfix"><div class="github-card"><p class="asidetitle">Github Card</p><div class="github-card" data-github="JasonRen23" data-theme="medium"></div><script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script></div><div class="categorieslist"><p class="asidetitle">Categories</p><ul><li><a href="/categories/IDE/" title="IDE">IDE<sup>1</sup></a></li><li><a href="/categories/Java/" title="Java">Java<sup>12</sup></a></li><li><a href="/categories/Python/" title="Python">Python<sup>2</sup></a></li><li><a href="/categories/linux/" title="linux">linux<sup>1</sup></a></li><li><a href="/categories/前端/" title="前端">前端<sup>3</sup></a></li><li><a href="/categories/容器云/" title="容器云">容器云<sup>2</sup></a></li><li><a href="/categories/搜索引擎/" title="搜索引擎">搜索引擎<sup>1</sup></a></li><li><a href="/categories/操作系统/" title="操作系统">操作系统<sup>1</sup></a></li><li><a href="/categories/数据库/" title="数据库">数据库<sup>2</sup></a></li><li><a href="/categories/消息队列/" title="消息队列">消息队列<sup>1</sup></a></li><li><a href="/categories/算法/" title="算法">算法<sup>1</sup></a></li><li><a href="/categories/计算机网络/" title="计算机网络">计算机网络<sup>1</sup></a></li></ul></div><div class="tagslist"><p class="asidetitle">Tags</p><ul class="clearfix"><li><a href="/tags/并发/" title="并发">并发<sup>6</sup></a></li><li><a href="/tags/JVM/" title="JVM">JVM<sup>3</sup></a></li><li><a href="/tags/Meteor/" title="Meteor">Meteor<sup>2</sup></a></li><li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>2</sup></a></li><li><a href="/tags/Web技术/" title="Web技术">Web技术<sup>2</sup></a></li><li><a href="/tags/Maven/" title="Maven">Maven<sup>1</sup></a></li><li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li><li><a href="/tags/TCP-UDP/" title="TCP/UDP">TCP/UDP<sup>1</sup></a></li><li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li><li><a href="/tags/docker/" title="docker">docker<sup>1</sup></a></li><li><a href="/tags/Kafka/" title="Kafka">Kafka<sup>1</sup></a></li><li><a href="/tags/redis/" title="redis">redis<sup>1</sup></a></li><li><a href="/tags/sublime/" title="sublime">sublime<sup>1</sup></a></li><li><a href="/tags/shell脚本/" title="shell脚本">shell脚本<sup>1</sup></a></li><li><a href="/tags/Solr/" title="Solr">Solr<sup>1</sup></a></li><li><a href="/tags/快速排序/" title="快速排序">快速排序<sup>1</sup></a></li><li><a href="/tags/连接池/" title="连接池">连接池<sup>1</sup></a></li><li><a href="/tags/SQL/" title="SQL">SQL<sup>1</sup></a></li><li><a href="/tags/kubernetes/" title="kubernetes">kubernetes<sup>1</sup></a></li><li><a href="/tags/线程与进程/" title="线程与进程">线程与进程<sup>1</sup></a></li></ul></div><div class="rsspart"><a href="/atom.xml" target="_blank" title="rss">RSS</a></div></aside></div></div><footer><div id="footer"><div class="line"><span></span><div class="author"></div></div><section class="info"><p>Hello, I&#39;m JasonRen in Shu.<br>This is my blog, my mind.</p></section><div class="social-font"><a href="https://github.com/JasonRen23" target="_blank" class="icon-github" title="github"></a> <a href="http://www.zhihu.com/people/ren-zhi-cheng-1117" target="_blank" class="icon-zhihu" title="知乎"></a> <a href="mailto:zhicheng_ren@163.com" target="_blank" class="icon-email" title="Email Me"></a></div><p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 <a href="/about" target="_blank" title="JasonRen">JasonRen</a></p></div></footer><script src="/js/jquery-2.0.3.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script src="/js/jquery.qrcode-0.12.0.min.js"></script><script type="text/javascript">$(document).ready(function(){$(".navbar").click(function(){$("header nav").toggleClass("shownav")});var e=0,s=$("#main"),n=$("#asidepart"),a=$(".closeaside"),o=$(".openaside");a.click(function(){n.addClass("fadeOut").css("display","none"),o.css("display","block").addClass("fadeIn"),s.addClass("moveMain")}),o.click(function(){o.css("display","none").removeClass("beforeFadeIn"),n.css("display","block").removeClass("fadeOut").addClass("fadeIn"),s.removeClass("moveMain")}),$(window).scroll(function(){o.css("top",Math.max(80,260-$(this).scrollTop()))}),$(window).resize(function(){"number"==typeof window.innerWidth?e=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(e=document.documentElement.clientWidth),1024<=e?$("header nav").removeClass("shownav"):(s.removeClass("moveMain"),n.css("display","block").removeClass("fadeOut"),o.css("display","none"),$("#toc.toc-aside").css("display","none"))})})</script><script type="text/javascript">$(document).ready(function(){var c=$(".article-content>iframe"),n=$(".article-content>embed"),o=($("#toc"),$("#toc.toc-aside")),e=$(".openaside"),i=$(".closeaside");0<c.length&&c.wrap('<div class="video-container" />'),0<n.length&&n.wrap('<div class="video-container" />'),i.click(function(){o.css("display","block").addClass("fadeIn")}),e.click(function(){o.css("display","none")}),$(window).scroll(function(){o.css("top",Math.max(140,320-$(this).scrollTop()))})})</script><script type="text/javascript">$(document).ready(function(){var e=$(".share"),a=e.attr("data-url"),t=encodeURIComponent(a),r=e.attr("data-title"),i=e.attr("data-tsina"),c=(e.attr("description"),['<div class="hoverqrcode clearfix"></div>','<a class="overlay" id="qrcode"></a>','<a href="https://www.facebook.com/sharer.php?u='+t+'" class="article-share-facebook" target="_blank" title="Facebook"></a>','<a href="https://twitter.com/intent/tweet?url='+t+'" class="article-share-twitter" target="_blank" title="Twitter"></a>','<a href="#qrcode" class="article-share-qrcode" title="微信"></a>','<a href="http://widget.renren.com/dialog/share?resourceUrl='+t+"&srcUrl="+t+"&title="+r+'" class="article-share-renren" target="_blank" title="人人"></a>','<a href="http://service.weibo.com/share/share.php?title='+r+"&url="+t+"&ralateUid="+i+'&searchPic=true&style=number" class="article-share-weibo" target="_blank" title="微博"></a>','<span title="Share to"></span>'].join(""));e.append(c),$(".hoverqrcode").hide();var o=0;$(window).resize(function(){$(".hoverqrcode").hide()}),$(".article-share-qrcode").click(function(){!function(){"number"==typeof window.innerWidth?o=window.innerWidth:document.documentElement&&document.documentElement.clientWidth&&(o=document.documentElement.clientWidth);var e=1024<o?200:100,t={render:"image",size:e,fill:"#2ca6cb",text:a,radius:.5,quiet:1},r=$(".article-share-qrcode").position();$(".hoverqrcode").empty().css("width",e).css("height",e).css("left",r.left-e/2+20).css("top",r.top-e-10).qrcode(t)}(),$(".hoverqrcode").toggle()}),$(".article-share-qrcode").hover(function(){},function(){$(".hoverqrcode").hide()})})</script><script type="text/javascript">var disqus_shortname="jasonren";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}(),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">$(document).ready(function(){$(".article-content").each(function(a){$(this).find("img").each(function(){if(!$(this).parent().hasClass("fancybox")){var a=this.alt;a&&$(this).after('<span class="caption">'+a+"</span>"),$(this).wrap('<a href="'+this.src+'" title="'+a+'" class="fancybox"></a>')}}),$(this).find(".fancybox").each(function(){$(this).attr("rel","article"+a)})}),$.fancybox&&$(".fancybox").fancybox()})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="totop"><a title="Back to Top"><img src="/img/scrollup.png"></a></div><script src="/js/totop.js"></script></body>